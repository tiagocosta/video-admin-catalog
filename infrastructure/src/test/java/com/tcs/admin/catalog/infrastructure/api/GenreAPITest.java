package com.tcs.admin.catalog.infrastructure.api;import com.fasterxml.jackson.databind.ObjectMapper;import com.tcs.admin.catalog.ControllerTest;import com.tcs.admin.catalog.application.genre.create.CreateGenreOutput;import com.tcs.admin.catalog.application.genre.create.CreateGenreUseCase;import com.tcs.admin.catalog.domain.exceptions.NotificationException;import com.tcs.admin.catalog.domain.validation.Error;import com.tcs.admin.catalog.domain.validation.handler.Notification;import com.tcs.admin.catalog.infrastructure.genre.models.CreateGenreRequest;import org.hamcrest.Matchers;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.MediaType;import org.springframework.test.context.bean.override.mockito.MockitoBean;import org.springframework.test.web.servlet.MockMvc;import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;import java.util.List;import java.util.Objects;import static org.mockito.Mockito.*;import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;@ControllerTest(controllers = GenreAPI.class)public class GenreAPITest {    @Autowired    private MockMvc mockMvc;    @Autowired    private ObjectMapper mapper;    @MockitoBean    private CreateGenreUseCase createGenreUseCase;    @Test    public void givenValidCommand_whenCallsCreateGenre_thenReturnGenreId() throws Exception {        final var expectedName = "Drama";        final var expectedIsActive = true;        final var expectedCategories = List.of("123", "456");        final var expectedId = "123";        final var anInput =                new CreateGenreRequest(expectedName, expectedIsActive, expectedCategories);        when(createGenreUseCase.execute(any()))                .thenReturn(CreateGenreOutput.from(expectedId));        final var request = MockMvcRequestBuilders.post("/genres")                .contentType(MediaType.APPLICATION_JSON)                .content(mapper.writeValueAsString(anInput));        this.mockMvc.perform(request)                .andDo(print())                .andExpect(status().isCreated())                .andExpect(header().string("Location", "/genres/123"))                .andExpect(header().string("Content-Type", MediaType.APPLICATION_JSON_VALUE))                .andExpect(jsonPath("$.id", Matchers.equalTo("123")));        verify(createGenreUseCase, times(1)).execute(argThat(cmd ->                Objects.equals(expectedName, cmd.name())                        && Objects.equals(expectedIsActive, cmd.isActive())                        && Objects.equals(expectedCategories, cmd.categories())        ));    }    @Test    public void givenInvalidName_whenCallsCreateGenre_thenReturnNotification() throws Exception {        final String expectedName = null;        final var expectedIsActive = true;        final var expectedCategories = List.of("123", "456");        final var expectedErrorMessage = "'name' should not be null";        final var anInput =                new CreateGenreRequest(expectedName, expectedIsActive, expectedCategories);        when(createGenreUseCase.execute(any()))                .thenThrow(new NotificationException("Error", Notification.create(new Error(expectedErrorMessage))));        final var request = MockMvcRequestBuilders.post("/genres")                .contentType(MediaType.APPLICATION_JSON)                .content(mapper.writeValueAsString(anInput));        this.mockMvc.perform(request)                .andDo(print())                .andExpect(status().isUnprocessableEntity())                .andExpect(header().string("Content-Type", MediaType.APPLICATION_JSON_VALUE))                .andExpect(jsonPath("$.errors", Matchers.hasSize(1)))                .andExpect(jsonPath("$.errors[0].message", Matchers.equalTo(expectedErrorMessage)));        verify(createGenreUseCase, times(1)).execute(argThat(cmd ->                Objects.equals(expectedName, cmd.name())                        && Objects.equals(expectedIsActive, cmd.isActive())                        && Objects.equals(expectedCategories, cmd.categories())        ));    }}